<!doctype html><html lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="description" content="A story sharing platform where users can share their stories with locations on a map"><meta name="theme-color" content="#4f46e5"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="apple-mobile-web-app-title" content="Story Map"><link rel="manifest" href="/submitan-pertama-Intermediate/manifest.webmanifest" id="manifest-link" crossorigin="use-credentials"><link rel="shortcut icon" href="/submitan-pertama-Intermediate/favicon.png"><link rel="apple-touch-icon" href="/submitan-pertama-Intermediate/images/logo.png" id="apple-touch-icon"><title>Story Map - Share Your Stories</title><script defer="defer" src="/submitan-pertama-Intermediate/app.bundle.js"></script><link href="/submitan-pertama-Intermediate/app.css" rel="stylesheet"></head><body><a href="#main-content" class="skip-link">Skip to main content</a><header><div class="main-header container"><a class="brand-name" href="#/" aria-label="Story Map Home">Story Map</a><nav id="navigation-drawer" class="navigation-drawer" aria-label="Main navigation"><ul id="nav-list" class="nav-list" role="menubar"><li role="none"><a href="#/" role="menuitem">Home</a></li><li role="none"><a href="#/about" role="menuitem">About</a></li><li role="none"><a href="#/add" role="menuitem">Add Story</a></li></ul></nav><div class="header-actions"><button id="notification-toggle" class="header-btn notification-btn" aria-label="Toggle push notifications"><span class="btn-icon">üîî</span> <span class="btn-text notification-status">Notifications</span></button> <button id="drawer-button" class="drawer-button" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="navigation-drawer"><span class="sr-only">Menu</span> ‚ò∞</button></div></div><div id="header-notification-container" class="header-notification-container" role="region" aria-live="polite" aria-atomic="true"></div></header><main id="main-content" class="main-content" tabindex="-1"></main><footer class="footer"><div class="container"><p>&copy; 2025 Story Map. All rights reserved.</p><div class="notification-controls" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;"><button id="install-button" class="btn btn-secondary install-btn" style="display: none;" aria-label="Install Story Map app">üì± Install App</button></div></div></footer><script>// Detect environment (development vs production)
      const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
      const BASE_PATH = isProduction ? '/submitan-pertama-Intermediate' : '';
      
      // Helper function to create path
      const createPath = (path) => {
        const fullPath = BASE_PATH ? `${BASE_PATH}${path}` : path;
        return fullPath.replace(/\/+/g, '/'); // Replace multiple slashes with single slash
      };
      
      // Verify manifest link is correct (don't change it, just verify)
      const manifestLink = document.getElementById('manifest-link');
      if (manifestLink) {
        const expectedPath = isProduction ? '/submitan-pertama-Intermediate/manifest.webmanifest' : '/manifest.webmanifest';
        const fullExpectedPath = window.location.origin + expectedPath;
        if (!manifestLink.href.includes(expectedPath)) {
          console.warn('‚ö†Ô∏è Manifest path might be incorrect. Expected to contain:', expectedPath);
        } else {
          console.log('‚úÖ Manifest path is correct:', manifestLink.href);
        }
      }
      
      const appleIcon = document.getElementById('apple-touch-icon');
      if (appleIcon && isProduction) {
        const iconPath = createPath('/images/logo.png');
        if (!appleIcon.href.includes(iconPath)) {
          appleIcon.href = iconPath;
        }
      }
      
      // Log manifest info for debugging and ensure it's detected by browser
      if (manifestLink) {
        console.log('üìã Manifest link:', manifestLink.href);
        console.log('üìã Manifest link element:', manifestLink);
        
        // Test if manifest is accessible
        fetch(manifestLink.href)
          .then(response => {
            if (response.ok) {
              console.log('‚úÖ Manifest is accessible (HTTP OK)');
              return response.json();
            } else {
              console.error('‚ùå Manifest not accessible:', response.status, response.statusText);
            }
          })
          .then(manifest => {
            if (manifest) {
              console.log('‚úÖ Manifest loaded successfully:');
              console.log('   Name:', manifest.name);
              console.log('   Short Name:', manifest.short_name);
              console.log('   Start URL:', manifest.start_url);
              console.log('   Scope:', manifest.scope);
              console.log('   Icons:', manifest.icons?.length || 0, 'icons');
              
              // Verify icons
              if (manifest.icons && manifest.icons.length > 0) {
                manifest.icons.forEach((icon, index) => {
                  console.log(`   Icon ${index + 1}:`, icon.src, icon.sizes);
                });
              }
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading manifest:', error);
          });
        
        // Force browser to re-check manifest
        const newLink = document.createElement('link');
        newLink.rel = 'manifest';
        newLink.href = manifestLink.href;
        newLink.id = 'manifest-link-check';
        document.head.appendChild(newLink);
        setTimeout(() => {
          document.head.removeChild(newLink);
        }, 100);
      }
      
      // Check if browser detects PWA
      if ('serviceWorker' in navigator) {
        console.log('‚úÖ Service Worker API supported');
      } else {
        console.warn('‚ö†Ô∏è Service Worker API not supported');
      }
      
      if ('BeforeInstallPromptEvent' in window) {
        console.log('‚úÖ Install prompt API supported');
      } else {
        console.log('‚ÑπÔ∏è Install prompt will use beforeinstallprompt event');
      }
      
      // Log environment info
      console.log('Environment:', isProduction ? 'Production' : 'Development');
      console.log('BASE_PATH:', BASE_PATH);
      console.log('Current URL:', window.location.href);

      // Helper function to wait for bundle to load
      async function waitForBundle(maxWait = 10000) {
        // Check immediately first
        if (window.NotificationHelper) {
          console.log('‚úÖ Bundle already loaded');
          return true;
        }
        
        console.log('‚è≥ Waiting for bundle to load...');
        const startTime = Date.now();
        let checkCount = 0;
        
        while (!window.NotificationHelper && (Date.now() - startTime) < maxWait) {
          checkCount++;
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Log every second
          if (checkCount % 10 === 0) {
            console.log(`‚è≥ Still waiting... (${Math.floor((Date.now() - startTime) / 1000)}s)`);
          }
        }
        
        const loaded = !!window.NotificationHelper;
        if (loaded) {
          console.log('‚úÖ Bundle loaded successfully');
        } else {
          console.error('‚ùå Bundle failed to load within timeout');
        }
        return loaded;
      }

      // Initialize everything after page loads
      // Use DOMContentLoaded instead of 'load' to start earlier
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('üìÑ DOM Content Loaded');
        
        // Wait a bit for bundle script to execute
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Check if bundle is loaded
        if (!window.NotificationHelper) {
          console.log('‚è≥ Bundle not yet loaded, waiting...');
          await waitForBundle();
        }
      });

      // Register service worker with correct scope for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const swPath = createPath('/sw.js');
            const swScope = isProduction ? '/submitan-pertama-Intermediate/' : '/';
            
            console.log('üîß Registering service worker...');
            console.log('   Path:', swPath);
            console.log('   Scope:', swScope);
            
            const registration = await navigator.serviceWorker.register(swPath, {
              scope: swScope
            });
            
            console.log('‚úÖ ServiceWorker registration successful');
            console.log('   Actual Scope:', registration.scope);
            console.log('   Active:', !!registration.active);
            console.log('   Installing:', !!registration.installing);
            console.log('   Waiting:', !!registration.waiting);
            
            // Wait for service worker to be ready
            if (registration.installing) {
              console.log('‚è≥ Service worker installing...');
              registration.installing.addEventListener('statechange', (e) => {
                console.log('   State changed to:', e.target.state);
              });
            }
            
            if (registration.waiting) {
              console.log('‚è≥ Service worker waiting...');
            }
            
            if (registration.active) {
              console.log('‚úÖ Service worker is active');
            }
            
            // Ensure bundle is loaded
            if (!window.NotificationHelper) {
              console.log('‚è≥ Waiting for bundle before initializing notifications...');
              await waitForBundle();
            }
            
            console.log('Bundle status:', {
              loaded: !!window.NotificationHelper,
              NotificationHelper: !!window.NotificationHelper,
              HeaderNotification: !!window.HeaderNotification,
              CONFIG: !!window.CONFIG
            });
            
            // Initialize notifications after service worker is ready
            try {
              await registration.ready;
              
              if (window.NotificationHelper) {
                // Check notification permission status
                const permissionStatus = Notification.permission;
                console.log('üì¢ Notification permission status:', permissionStatus);
                
                // If permission is default (not asked yet), show prompt
                if (permissionStatus === 'default') {
                  console.log('üì¢ Requesting notification permission...');
                  // Wait a bit before requesting to ensure page is fully loaded
                  setTimeout(async () => {
                    try {
                      const hasPermission = await window.NotificationHelper.requestPermission();
                      if (hasPermission) {
                        console.log('‚úÖ Notification permission granted');
                        // Show success notification
                        if (window.HeaderNotification) {
                          window.HeaderNotification.success(
                            'Notifikasi Diaktifkan',
                            'Anda akan menerima notifikasi dari Story Map',
                            4000
                          );
                        }
                        // Show test notification
                        await window.NotificationHelper.showLocalNotification(
                          'Notifikasi Diaktifkan',
                          {
                            body: 'Anda akan menerima notifikasi dari Story Map.',
                            icon: createPath('/images/logo.png'),
                            badge: createPath('/images/logo.png')
                          }
                        );
                      } else {
                        console.log('‚ùå Notification permission denied');
                        if (window.HeaderNotification) {
                          window.HeaderNotification.info(
                            'Izin Notifikasi',
                            'Klik tombol Notifications di header untuk mengaktifkan notifikasi',
                            5000
                          );
                        }
                      }
                    } catch (error) {
                      console.error('Error requesting notification permission:', error);
                    }
                  }, 2000);
                }
                
                await window.NotificationHelper.initialize();
                console.log('‚úÖ Notifications initialized');
              } else {
                console.warn('‚ö†Ô∏è NotificationHelper not available after waiting');
              }
            } catch (error) {
              console.error('‚ùå Error initializing notifications:', error);
            }
            
            // Initialize notification toggle
            const notificationToggle = document.getElementById('notification-toggle');
            if (notificationToggle) {
              notificationToggle.addEventListener('click', async (e) => {
                // Check if it's a long press or right click for test notification
                if (e.shiftKey || e.ctrlKey) {
                  e.preventDefault();
                  try {
                    if (!window.NotificationHelper) {
                      alert('NotificationHelper belum dimuat. Silakan refresh halaman.');
                      return;
                    }
                    const result = await window.NotificationHelper.testNotification();
                    if (!result) {
                      alert('Notifikasi tidak dapat ditampilkan. Pastikan izin notifikasi sudah diberikan.');
                    }
                  } catch (error) {
                    console.error('Error testing notification:', error);
                    alert('Gagal menampilkan notifikasi test: ' + error.message);
                  }
                  return;
                }

                try {
                  if (!window.NotificationHelper || !window.CONFIG) {
                    alert('Modul belum dimuat. Silakan refresh halaman.');
                    return;
                  }
                  
                  const NotificationHelper = window.NotificationHelper;
                  const CONFIG = window.CONFIG;
                  
                  // Check if push is supported
                  if (!(await NotificationHelper.isPushSupported())) {
                    alert('Push notifications are not supported in this browser.');
                    return;
                  }

                  // Request notification permission first
                  const hasPermission = await NotificationHelper.requestPermission();
                  if (!hasPermission) {
                    alert('Notification permission denied. Please enable it in your browser settings.');
                    return;
                  }

                  const subscription = await NotificationHelper.getSubscription();
                  
                  if (subscription) {
                    // Unsubscribe
                    const token = localStorage.getItem('token');
                    await NotificationHelper.unsubscribeUser(token);
                    const statusSpan = notificationToggle.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = 'Enable Notifications';
                    }
                    notificationToggle.classList.remove('active');
                    console.log('Unsubscribed from push notifications');
                  } else {
                    // Subscribe
                    const newSubscription = await NotificationHelper.subscribeUser(CONFIG.VAPID_PUBLIC_KEY);
                    
                    if (!newSubscription) {
                      alert('Failed to subscribe to push notifications. Please try again.');
                      return;
                    }
                    
                    // Send subscription to server
                    const token = localStorage.getItem('token');
                    if (token) {
                      const success = await NotificationHelper.sendSubscriptionToServer(newSubscription, token);
                      if (success) {
                        const statusSpan = notificationToggle.querySelector('.notification-status');
                        if (statusSpan) {
                          statusSpan.textContent = 'Disable Notifications';
                        }
                        notificationToggle.classList.add('active');
                        console.log('Subscribed to push notifications');
                      } else {
                        // Still store locally even if server sync fails
                        localStorage.setItem('pushSubscription', JSON.stringify(newSubscription));
                        const statusSpan = notificationToggle.querySelector('.notification-status');
                        if (statusSpan) {
                          statusSpan.textContent = 'Disable Notifications';
                        }
                        notificationToggle.classList.add('active');
                        alert('Subscribed locally, but failed to register with server. Will retry when online.');
                      }
                    } else {
                      // Store subscription locally if not logged in
                      localStorage.setItem('pushSubscription', JSON.stringify(newSubscription));
                      const statusSpan = notificationToggle.querySelector('.notification-status');
                      if (statusSpan) {
                        statusSpan.textContent = 'Disable Notifications';
                      }
                      notificationToggle.classList.add('active');
                      console.log('Subscribed to push notifications (will sync when logged in)');
                    }
                  }
                } catch (error) {
                  console.error('Error toggling notifications:', error);
                  alert('Failed to update notification settings: ' + error.message);
                }
              });

              // Update button text based on current subscription
              (async () => {
                try {
                  // Wait for bundle to load
                  const bundleLoaded = await waitForBundle();
                  
                  if (!bundleLoaded || !window.NotificationHelper) {
                    console.warn('NotificationHelper not available');
                    const toggleBtn = document.getElementById('notification-toggle');
                    if (toggleBtn) {
                      toggleBtn.style.display = 'none';
                    }
                    return;
                  }
                  
                  const NotificationHelper = window.NotificationHelper;
                  
                  // Check if push is supported
                  const isPushSupported = await NotificationHelper.isPushSupported();
                  console.log('Push notifications supported:', isPushSupported);
                  
                  const toggleBtn = document.getElementById('notification-toggle');
                  if (!isPushSupported) {
                    if (toggleBtn) {
                      console.log('Hiding notification button - push not supported');
                      toggleBtn.style.display = 'none';
                    }
                    return;
                  }

                  // Ensure button is visible and enabled
                  if (toggleBtn) {
                    toggleBtn.style.display = '';
                    toggleBtn.disabled = false;
                    console.log('‚úÖ Notification button is visible and enabled');
                  }

                  const subscription = await NotificationHelper.getSubscription();
                  console.log('Current subscription:', !!subscription);
                  
                  if (toggleBtn) {
                    const statusSpan = toggleBtn.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = subscription ? 'Disable Notifications' : 'Enable Notifications';
                    }
                    // Add active class if subscribed
                    if (subscription) {
                      toggleBtn.classList.add('active');
                    } else {
                      toggleBtn.classList.remove('active');
                    }
                    console.log('‚úÖ Notification button updated');
                  }
                } catch (error) {
                  console.error('‚ùå Error checking notification status:', error);
                  // Keep button visible even on error
                  const toggleBtn = document.getElementById('notification-toggle');
                  if (toggleBtn) {
                    toggleBtn.style.display = '';
                    toggleBtn.disabled = false;
                    console.log('‚úÖ Notification button kept visible despite error');
                  }
                }
              })();
            }

            // Handle PWA install prompt
            let deferredPrompt = null;
            let installButtonClickHandler = null;
            
            // Check if app is already installed
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone || 
                               document.referrer.includes('android-app://');
            
            // Show install button in footer if not installed
            const showInstallButton = () => {
              const installButton = document.getElementById('install-button');
              if (installButton && !isInstalled) {
                installButton.style.display = 'inline-block';
                console.log('‚úÖ Install button shown');
              }
            };
            
            // Log install prompt availability
            console.log('üîç Checking for install prompt support...');
            console.log('Service Worker support:', 'serviceWorker' in navigator);
            console.log('Manifest link:', document.querySelector('link[rel="manifest"]')?.href);
            console.log('Is installed:', isInstalled);
            
            window.addEventListener('beforeinstallprompt', (e) => {
              console.log('üéâ beforeinstallprompt event fired!');
              e.preventDefault();
              deferredPrompt = e;
              
              // Show install button
              showInstallButton();
              
              const installButton = document.getElementById('install-button');
              if (installButton) {
                // Remove existing listener if any
                if (installButtonClickHandler) {
                  installButton.removeEventListener('click', installButtonClickHandler);
                }
                
                // Add new click handler
                installButtonClickHandler = async () => {
                  if (deferredPrompt) {
                    try {
                      console.log('üì± Showing install prompt...');
                      deferredPrompt.prompt();
                      const { outcome } = await deferredPrompt.userChoice;
                      console.log(`User response to install prompt: ${outcome}`);
                      
                      if (outcome === 'accepted') {
                        console.log('‚úÖ User accepted installation');
                        // Show success message
                        try {
                          if (window.HeaderNotification) {
                            window.HeaderNotification.success(
                            'Aplikasi Berhasil Diinstal',
                            'Terima kasih! Aplikasi Story Map sedang diinstal.',
                            3000
                          );
                        } catch (err) {
                          alert('Terima kasih! Aplikasi Story Map sedang diinstal.');
                        }
                      } else {
                        console.log('‚ùå User dismissed installation');
                      }
                      
                      deferredPrompt = null;
                      installButton.style.display = 'none';
                    } catch (error) {
                      console.error('‚ùå Error showing install prompt:', error);
                      alert('Gagal menampilkan prompt instalasi: ' + error.message);
                    }
                  } else {
                    console.warn('‚ö†Ô∏è deferredPrompt is null');
                  }
                };
                
                installButton.addEventListener('click', installButtonClickHandler);
                console.log('‚úÖ Install button click handler attached');
              } else {
                console.error('‚ùå Install button not found in DOM');
              }
            });
            
            // Always show install button after page loads (if not installed)
            setTimeout(async () => {
              if (!isInstalled) {
                console.log('üîç Checking PWA requirements...');
                console.log('Service Worker:', 'serviceWorker' in navigator);
                const manifestHref = document.querySelector('link[rel="manifest"]')?.href;
                console.log('Manifest:', manifestHref);
                
                // Check if manifest is accessible
                if (manifestHref) {
                  try {
                    const manifestResponse = await fetch(manifestHref);
                    if (manifestResponse.ok) {
                      const manifest = await manifestResponse.json();
                      console.log('‚úÖ Manifest loaded:', manifest);
                    } else {
                      console.error('‚ùå Manifest not accessible:', manifestResponse.status);
                    }
                  } catch (error) {
                    console.error('‚ùå Error loading manifest:', error);
                  }
                }
                
                // Check service worker registration
                try {
                  const registration = await navigator.serviceWorker.getRegistration();
                  console.log('Service Worker registered:', !!registration);
                  if (registration) {
                    console.log('Service Worker scope:', registration.scope);
                    console.log('Service Worker active:', !!registration.active);
                  }
                } catch (error) {
                  console.error('Error checking service worker:', error);
                }
                
                // Always show install button (even if beforeinstallprompt didn't fire)
                const installButton = document.getElementById('install-button');
                if (installButton) {
                  installButton.style.display = 'inline-block';
                  installButton.textContent = 'üì± Install App';
                  
                  // Set click handler based on whether we have deferredPrompt
                  if (deferredPrompt && installButtonClickHandler) {
                    // Use the beforeinstallprompt handler if available
                    installButton.onclick = installButtonClickHandler;
                    console.log('‚úÖ Install button with prompt handler');
                  } else {
                    // Use manual install instructions
                    installButton.onclick = () => {
                      if (deferredPrompt) {
                        // Try to use prompt if available
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                          if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted install');
                            if (window.HeaderNotification) {
                              window.HeaderNotification.success(
                                'Aplikasi Berhasil Diinstal',
                                'Terima kasih! Aplikasi Story Map sedang diinstal.',
                                3000
                              );
                            }
                          }
                          deferredPrompt = null;
                        });
                      } else {
                        // Show manual instructions
                        const instructions = 
                          'Cara Install Aplikasi:\n\n' +
                          'Chrome/Edge Desktop:\n' +
                          '‚Ä¢ Klik menu (‚ãÆ) di kanan atas\n' +
                          '‚Ä¢ Pilih "Install Story Map"\n\n' +
                          'Chrome Android:\n' +
                          '‚Ä¢ Klik menu (‚ãÆ) > "Install app"\n\n' +
                          'Safari iOS:\n' +
                          '‚Ä¢ Klik tombol Share (‚ñ°‚Üë)\n' +
                          '‚Ä¢ Pilih "Add to Home Screen"\n\n' +
                          'Firefox:\n' +
                          '‚Ä¢ Klik menu (‚ò∞) > "Install"';
                        alert(instructions);
                      }
                    };
                    console.log('üì± Install button shown with manual instructions');
                  }
                }
              } else {
                console.log('‚úÖ App already installed');
              }
            }, 2000);

            // Listen for app installed
            window.addEventListener('appinstalled', () => {
              console.log('PWA was installed');
              deferredPrompt = null;
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'none';
              }
              
              // Show notification
              (async () => {
                try {
                  if (window.HeaderNotification) {
                    window.HeaderNotification.success(
                      'Aplikasi Terinstal!',
                      'Story Map telah berhasil diinstal di perangkat Anda.',
                      4000
                    );
                  }
                } catch (err) {
                  console.error('Error showing install notification:', err);
                }
              })();
            });
            
            // Check if already installed on page load
            if (isInstalled) {
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'none';
              }
            }
          } catch (error) {
            console.error('ServiceWorker registration failed: ', error);
          }
        });
      }

      // Listen for online/offline status
      function updateOnlineStatus() {
        const statusElement = document.getElementById('online-status');
        if (statusElement) {
          if (navigator.onLine) {
            statusElement.textContent = 'Online';
            statusElement.className = 'online';
          } else {
            statusElement.textContent = 'Offline - Working in offline mode';
            statusElement.className = 'offline';
          }
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      document.addEventListener('DOMContentLoaded', updateOnlineStatus);</script></body></html>