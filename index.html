<!doctype html><html lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="description" content="A story sharing platform where users can share their stories with locations on a map"><meta name="theme-color" content="#4f46e5"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="apple-mobile-web-app-title" content="Story Map"><link rel="manifest" href="/submitan-pertama-Intermediate/manifest.webmanifest"><link rel="shortcut icon" href="favicon.png"><link rel="apple-touch-icon" href="/submitan-pertama-Intermediate/images/logo.png"><title>Story Map - Share Your Stories</title><script defer="defer" src="/submitan-pertama-Intermediate/app.bundle.js"></script><link href="/submitan-pertama-Intermediate/app.css" rel="stylesheet"></head><body><a href="#main-content" class="skip-link">Skip to main content</a><header><div class="main-header container"><a class="brand-name" href="#/" aria-label="Story Map Home">Story Map</a><nav id="navigation-drawer" class="navigation-drawer" aria-label="Main navigation"><ul id="nav-list" class="nav-list" role="menubar"><li role="none"><a href="#/" role="menuitem">Home</a></li><li role="none"><a href="#/about" role="menuitem">About</a></li><li role="none"><a href="#/add" role="menuitem">Add Story</a></li></ul></nav><button id="drawer-button" class="drawer-button" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="navigation-drawer"><span class="sr-only">Menu</span> â˜°</button></div></header><main id="main-content" class="main-content" tabindex="-1"></main><footer class="footer"><div class="container"><p>&copy; 2025 Story Map. All rights reserved.</p><div class="notification-controls" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;"><button id="install-button" class="btn btn-secondary" style="display: none;">Install App</button> <button id="notification-toggle" class="btn btn-secondary"><span class="notification-status">Enable Notifications</span></button></div></div></footer><script>// Register service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const registration = await navigator.serviceWorker.register('/submitan-pertama-Intermediate/sw.js');
            console.log('ServiceWorker registration successful:', registration.scope);
            
            // Initialize notification toggle
            const notificationToggle = document.getElementById('notification-toggle');
            if (notificationToggle) {
              notificationToggle.addEventListener('click', async () => {
                try {
                  const { default: NotificationHelper } = await import('./scripts/utils/notification.js');
                  const { default: CONFIG } = await import('./scripts/config.js');
                  
                  // Check if push is supported
                  if (!(await NotificationHelper.isPushSupported())) {
                    alert('Push notifications are not supported in this browser.');
                    return;
                  }

                  // Request notification permission first
                  const hasPermission = await NotificationHelper.requestPermission();
                  if (!hasPermission) {
                    alert('Notification permission denied. Please enable it in your browser settings.');
                    return;
                  }

                  const subscription = await NotificationHelper.getSubscription();
                  
                  if (subscription) {
                    // Unsubscribe
                    await NotificationHelper.unsubscribeUser();
                    notificationToggle.querySelector('.notification-status').textContent = 'Enable Notifications';
                    console.log('Unsubscribed from push notifications');
                  } else {
                    // Subscribe
                    const newSubscription = await NotificationHelper.subscribeUser(CONFIG.VAPID_PUBLIC_KEY);
                    
                    // Send subscription to server
                    const token = localStorage.getItem('token');
                    if (token) {
                      const success = await NotificationHelper.sendSubscriptionToServer(newSubscription, token);
                      if (success) {
                        notificationToggle.querySelector('.notification-status').textContent = 'Disable Notifications';
                        console.log('Subscribed to push notifications');
                      } else {
                        alert('Failed to register subscription with server. Please try again.');
                      }
                    } else {
                      // Store subscription locally if not logged in
                      localStorage.setItem('pushSubscription', JSON.stringify(newSubscription));
                      notificationToggle.querySelector('.notification-status').textContent = 'Disable Notifications';
                      console.log('Subscribed to push notifications (will sync when logged in)');
                    }
                  }
                } catch (error) {
                  console.error('Error toggling notifications:', error);
                  alert('Failed to update notification settings: ' + error.message);
                }
              });

              // Update button text based on current subscription
              (async () => {
                try {
                  const { default: NotificationHelper } = await import('./scripts/utils/notification.js');
                  const subscription = await NotificationHelper.getSubscription();
                  const toggleBtn = document.getElementById('notification-toggle');
                  if (toggleBtn) {
                    const statusSpan = toggleBtn.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = subscription ? 'Disable Notifications' : 'Enable Notifications';
                    }
                  }
                } catch (error) {
                  console.error('Error checking notification status:', error);
                }
              })();
            }

            // Handle PWA install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
              e.preventDefault();
              deferredPrompt = e;
              
              // Show install button if available
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'block';
                installButton.addEventListener('click', async () => {
                  if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                  }
                });
              }
            });

            // Listen for app installed
            window.addEventListener('appinstalled', () => {
              console.log('PWA was installed');
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'none';
              }
            });
          } catch (error) {
            console.error('ServiceWorker registration failed: ', error);
          }
        });
      }

      // Listen for online/offline status
      function updateOnlineStatus() {
        const statusElement = document.getElementById('online-status');
        if (statusElement) {
          if (navigator.onLine) {
            statusElement.textContent = 'Online';
            statusElement.className = 'online';
          } else {
            statusElement.textContent = 'Offline - Working in offline mode';
            statusElement.className = 'offline';
          }
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      document.addEventListener('DOMContentLoaded', updateOnlineStatus);</script></body></html>