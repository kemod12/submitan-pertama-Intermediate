<!doctype html><html lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="description" content="A story sharing platform where users can share their stories with locations on a map"><meta name="theme-color" content="#4f46e5"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="apple-mobile-web-app-title" content="Story Map"><link rel="manifest" href="/manifest.webmanifest" id="manifest-link"><link rel="shortcut icon" href="favicon.png"><link rel="apple-touch-icon" href="/images/logo.png" id="apple-touch-icon"><title>Story Map - Share Your Stories</title><script defer="defer" src="/submitan-pertama-Intermediate/app.bundle.js"></script><link href="/submitan-pertama-Intermediate/app.css" rel="stylesheet"></head><body><a href="#main-content" class="skip-link">Skip to main content</a><header><div class="main-header container"><a class="brand-name" href="#/" aria-label="Story Map Home">Story Map</a><nav id="navigation-drawer" class="navigation-drawer" aria-label="Main navigation"><ul id="nav-list" class="nav-list" role="menubar"><li role="none"><a href="#/" role="menuitem">Home</a></li><li role="none"><a href="#/about" role="menuitem">About</a></li><li role="none"><a href="#/add" role="menuitem">Add Story</a></li></ul></nav><div class="header-actions"><button id="notification-toggle" class="header-btn notification-btn" aria-label="Toggle push notifications"><span class="btn-icon">üîî</span> <span class="btn-text notification-status">Notifications</span></button> <button id="drawer-button" class="drawer-button" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="navigation-drawer"><span class="sr-only">Menu</span> ‚ò∞</button></div></div><div id="header-notification-container" class="header-notification-container" role="region" aria-live="polite" aria-atomic="true"></div></header><main id="main-content" class="main-content" tabindex="-1"></main><footer class="footer"><div class="container"><p>&copy; 2025 Story Map. All rights reserved.</p><div class="notification-controls" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;"><button id="install-button" class="btn btn-secondary install-btn" style="display: none;" aria-label="Install Story Map app">üì± Install App</button></div></div></footer><script>// Detect environment (development vs production)
      const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
      const BASE_PATH = isProduction ? '/submitan-pertama-Intermediate' : '';
      
      // Helper function to create path
      const createPath = (path) => {
        const fullPath = BASE_PATH ? `${BASE_PATH}${path}` : path;
        return fullPath.replace(/\/+/g, '/'); // Replace multiple slashes with single slash
      };
      
      // Update manifest and icon paths dynamically
      const manifestLink = document.getElementById('manifest-link');
      if (manifestLink) {
        const manifestPath = createPath('/manifest.webmanifest');
        manifestLink.href = manifestPath;
        console.log('Manifest path updated to:', manifestPath);
      }
      
      const appleIcon = document.getElementById('apple-touch-icon');
      if (appleIcon) {
        appleIcon.href = createPath('/images/logo.png');
      }
      
      // Ensure manifest is accessible
      if (manifestLink) {
        manifestLink.setAttribute('crossorigin', 'use-credentials');
      }
      
      // Log environment info
      console.log('Environment:', isProduction ? 'Production' : 'Development');
      console.log('BASE_PATH:', BASE_PATH);
      console.log('Current URL:', window.location.href);

      // Helper function to wait for bundle to load
      async function waitForBundle(maxWait = 10000) {
        // Check immediately first
        if (window.NotificationHelper) {
          console.log('‚úÖ Bundle already loaded');
          return true;
        }
        
        console.log('‚è≥ Waiting for bundle to load...');
        const startTime = Date.now();
        let checkCount = 0;
        
        while (!window.NotificationHelper && (Date.now() - startTime) < maxWait) {
          checkCount++;
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Log every second
          if (checkCount % 10 === 0) {
            console.log(`‚è≥ Still waiting... (${Math.floor((Date.now() - startTime) / 1000)}s)`);
          }
        }
        
        const loaded = !!window.NotificationHelper;
        if (loaded) {
          console.log('‚úÖ Bundle loaded successfully');
        } else {
          console.error('‚ùå Bundle failed to load within timeout');
        }
        return loaded;
      }

      // Initialize everything after page loads
      // Use DOMContentLoaded instead of 'load' to start earlier
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('üìÑ DOM Content Loaded');
        
        // Wait a bit for bundle script to execute
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Check if bundle is loaded
        if (!window.NotificationHelper) {
          console.log('‚è≥ Bundle not yet loaded, waiting...');
          await waitForBundle();
        }
      });

      // Register service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const swPath = createPath('/sw.js');
            const registration = await navigator.serviceWorker.register(swPath);
            console.log('ServiceWorker registration successful:', registration.scope);
            
            // Ensure bundle is loaded
            if (!window.NotificationHelper) {
              console.log('‚è≥ Waiting for bundle before initializing notifications...');
              await waitForBundle();
            }
            
            console.log('Bundle status:', {
              loaded: !!window.NotificationHelper,
              NotificationHelper: !!window.NotificationHelper,
              HeaderNotification: !!window.HeaderNotification,
              CONFIG: !!window.CONFIG
            });
            
            // Initialize notifications after service worker is ready
            try {
              await registration.ready;
              
              if (window.NotificationHelper) {
                await window.NotificationHelper.initialize();
                console.log('Notifications initialized');
              } else {
                console.warn('NotificationHelper not available after waiting');
              }
            } catch (error) {
              console.error('Error initializing notifications:', error);
            }
            
            // Initialize notification toggle
            const notificationToggle = document.getElementById('notification-toggle');
            if (notificationToggle) {
              notificationToggle.addEventListener('click', async (e) => {
                // Check if it's a long press or right click for test notification
                if (e.shiftKey || e.ctrlKey) {
                  e.preventDefault();
                  try {
                    if (!window.NotificationHelper) {
                      alert('NotificationHelper belum dimuat. Silakan refresh halaman.');
                      return;
                    }
                    const result = await window.NotificationHelper.testNotification();
                    if (!result) {
                      alert('Notifikasi tidak dapat ditampilkan. Pastikan izin notifikasi sudah diberikan.');
                    }
                  } catch (error) {
                    console.error('Error testing notification:', error);
                    alert('Gagal menampilkan notifikasi test: ' + error.message);
                  }
                  return;
                }

                try {
                  if (!window.NotificationHelper || !window.CONFIG) {
                    alert('Modul belum dimuat. Silakan refresh halaman.');
                    return;
                  }
                  
                  const NotificationHelper = window.NotificationHelper;
                  const CONFIG = window.CONFIG;
                  
                  // Check if push is supported
                  if (!(await NotificationHelper.isPushSupported())) {
                    alert('Push notifications are not supported in this browser.');
                    return;
                  }

                  // Request notification permission first
                  const hasPermission = await NotificationHelper.requestPermission();
                  if (!hasPermission) {
                    alert('Notification permission denied. Please enable it in your browser settings.');
                    return;
                  }

                  const subscription = await NotificationHelper.getSubscription();
                  
                  if (subscription) {
                    // Unsubscribe
                    const token = localStorage.getItem('token');
                    await NotificationHelper.unsubscribeUser(token);
                    const statusSpan = notificationToggle.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = 'Enable Notifications';
                    }
                    notificationToggle.classList.remove('active');
                    console.log('Unsubscribed from push notifications');
                  } else {
                    // Subscribe
                    const newSubscription = await NotificationHelper.subscribeUser(CONFIG.VAPID_PUBLIC_KEY);
                    
                    if (!newSubscription) {
                      alert('Failed to subscribe to push notifications. Please try again.');
                      return;
                    }
                    
                    // Send subscription to server
                    const token = localStorage.getItem('token');
                    if (token) {
                      const success = await NotificationHelper.sendSubscriptionToServer(newSubscription, token);
                      if (success) {
                        const statusSpan = notificationToggle.querySelector('.notification-status');
                        if (statusSpan) {
                          statusSpan.textContent = 'Disable Notifications';
                        }
                        notificationToggle.classList.add('active');
                        console.log('Subscribed to push notifications');
                      } else {
                        // Still store locally even if server sync fails
                        localStorage.setItem('pushSubscription', JSON.stringify(newSubscription));
                        const statusSpan = notificationToggle.querySelector('.notification-status');
                        if (statusSpan) {
                          statusSpan.textContent = 'Disable Notifications';
                        }
                        notificationToggle.classList.add('active');
                        alert('Subscribed locally, but failed to register with server. Will retry when online.');
                      }
                    } else {
                      // Store subscription locally if not logged in
                      localStorage.setItem('pushSubscription', JSON.stringify(newSubscription));
                      const statusSpan = notificationToggle.querySelector('.notification-status');
                      if (statusSpan) {
                        statusSpan.textContent = 'Disable Notifications';
                      }
                      notificationToggle.classList.add('active');
                      console.log('Subscribed to push notifications (will sync when logged in)');
                    }
                  }
                } catch (error) {
                  console.error('Error toggling notifications:', error);
                  alert('Failed to update notification settings: ' + error.message);
                }
              });

              // Update button text based on current subscription
              (async () => {
                try {
                  // Wait for bundle to load
                  const bundleLoaded = await waitForBundle();
                  
                  if (!bundleLoaded || !window.NotificationHelper) {
                    console.warn('NotificationHelper not available');
                    const toggleBtn = document.getElementById('notification-toggle');
                    if (toggleBtn) {
                      toggleBtn.style.display = 'none';
                    }
                    return;
                  }
                  
                  const NotificationHelper = window.NotificationHelper;
                  
                  // Check if push is supported
                  const isPushSupported = await NotificationHelper.isPushSupported();
                  console.log('Push notifications supported:', isPushSupported);
                  
                  const toggleBtn = document.getElementById('notification-toggle');
                  if (!isPushSupported) {
                    if (toggleBtn) {
                      console.log('Hiding notification button - push not supported');
                      toggleBtn.style.display = 'none';
                    }
                    return;
                  }

                  // Ensure button is visible
                  if (toggleBtn) {
                    toggleBtn.style.display = '';
                  }

                  const subscription = await NotificationHelper.getSubscription();
                  console.log('Current subscription:', !!subscription);
                  
                  if (toggleBtn) {
                    const statusSpan = toggleBtn.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = subscription ? 'Disable Notifications' : 'Enable Notifications';
                    }
                    // Add active class if subscribed
                    if (subscription) {
                      toggleBtn.classList.add('active');
                    } else {
                      toggleBtn.classList.remove('active');
                    }
                    console.log('Notification button updated');
                  }
                } catch (error) {
                  console.error('Error checking notification status:', error);
                  // Don't hide button on error, just log it
                  const toggleBtn = document.getElementById('notification-toggle');
                  if (toggleBtn) {
                    console.log('Notification button still visible despite error');
                  }
                }
              })();
            }

            // Handle PWA install prompt
            let deferredPrompt = null;
            let installButtonClickHandler = null;
            
            // Check if app is already installed
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone || 
                               document.referrer.includes('android-app://');
            
            // Show install button in footer if not installed
            const showInstallButton = () => {
              const installButton = document.getElementById('install-button');
              if (installButton && !isInstalled) {
                installButton.style.display = 'inline-block';
                console.log('‚úÖ Install button shown');
              }
            };
            
            // Log install prompt availability
            console.log('üîç Checking for install prompt support...');
            console.log('Service Worker support:', 'serviceWorker' in navigator);
            console.log('Manifest link:', document.querySelector('link[rel="manifest"]')?.href);
            console.log('Is installed:', isInstalled);
            
            window.addEventListener('beforeinstallprompt', (e) => {
              console.log('üéâ beforeinstallprompt event fired!');
              e.preventDefault();
              deferredPrompt = e;
              
              // Show install button
              showInstallButton();
              
              const installButton = document.getElementById('install-button');
              if (installButton) {
                // Remove existing listener if any
                if (installButtonClickHandler) {
                  installButton.removeEventListener('click', installButtonClickHandler);
                }
                
                // Add new click handler
                installButtonClickHandler = async () => {
                  if (deferredPrompt) {
                    try {
                      console.log('üì± Showing install prompt...');
                      deferredPrompt.prompt();
                      const { outcome } = await deferredPrompt.userChoice;
                      console.log(`User response to install prompt: ${outcome}`);
                      
                      if (outcome === 'accepted') {
                        console.log('‚úÖ User accepted installation');
                        // Show success message
                        try {
                          if (window.HeaderNotification) {
                            window.HeaderNotification.success(
                            'Aplikasi Berhasil Diinstal',
                            'Terima kasih! Aplikasi Story Map sedang diinstal.',
                            3000
                          );
                        } catch (err) {
                          alert('Terima kasih! Aplikasi Story Map sedang diinstal.');
                        }
                      } else {
                        console.log('‚ùå User dismissed installation');
                      }
                      
                      deferredPrompt = null;
                      installButton.style.display = 'none';
                    } catch (error) {
                      console.error('‚ùå Error showing install prompt:', error);
                      alert('Gagal menampilkan prompt instalasi: ' + error.message);
                    }
                  } else {
                    console.warn('‚ö†Ô∏è deferredPrompt is null');
                  }
                };
                
                installButton.addEventListener('click', installButtonClickHandler);
                console.log('‚úÖ Install button click handler attached');
              } else {
                console.error('‚ùå Install button not found in DOM');
              }
            });
            
            // Check if install prompt is available after a delay
            setTimeout(async () => {
              if (!deferredPrompt && !isInstalled) {
                console.log('‚ö†Ô∏è Install prompt not available. Checking requirements...');
                console.log('Service Worker:', 'serviceWorker' in navigator);
                const manifestHref = document.querySelector('link[rel="manifest"]')?.href;
                console.log('Manifest:', manifestHref);
                
                // Check if manifest is accessible
                if (manifestHref) {
                  try {
                    const manifestResponse = await fetch(manifestHref);
                    if (manifestResponse.ok) {
                      const manifest = await manifestResponse.json();
                      console.log('Manifest loaded:', manifest);
                    } else {
                      console.error('Manifest not accessible:', manifestResponse.status);
                    }
                  } catch (error) {
                    console.error('Error loading manifest:', error);
                  }
                }
                
                // Check service worker registration
                try {
                  const registration = await navigator.serviceWorker.getRegistration();
                  console.log('Service Worker registered:', !!registration);
                  if (registration) {
                    console.log('Service Worker scope:', registration.scope);
                    console.log('Service Worker active:', !!registration.active);
                  }
                } catch (error) {
                  console.error('Error checking service worker:', error);
                }
                
                // Try to show install button anyway for manual install
                const installButton = document.getElementById('install-button');
                if (installButton) {
                  // Show button with manual install instructions
                  installButton.style.display = 'inline-block';
                  installButton.textContent = 'üì± Install App';
                  installButton.onclick = () => {
                    const instructions = 
                      'Cara Install Aplikasi:\n\n' +
                      'Chrome/Edge Desktop:\n' +
                      '‚Ä¢ Klik menu (‚ãÆ) di kanan atas\n' +
                      '‚Ä¢ Pilih "Install Story Map"\n\n' +
                      'Chrome Android:\n' +
                      '‚Ä¢ Klik menu (‚ãÆ) > "Install app"\n\n' +
                      'Safari iOS:\n' +
                      '‚Ä¢ Klik tombol Share (‚ñ°‚Üë)\n' +
                      '‚Ä¢ Pilih "Add to Home Screen"\n\n' +
                      'Firefox:\n' +
                      '‚Ä¢ Klik menu (‚ò∞) > "Install"';
                    alert(instructions);
                  };
                  console.log('üì± Manual install button shown');
                }
              } else if (deferredPrompt) {
                console.log('‚úÖ Install prompt available, button should be shown');
                showInstallButton();
              }
            }, 3000);

            // Listen for app installed
            window.addEventListener('appinstalled', () => {
              console.log('PWA was installed');
              deferredPrompt = null;
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'none';
              }
              
              // Show notification
              (async () => {
                try {
                  if (window.HeaderNotification) {
                    window.HeaderNotification.success(
                      'Aplikasi Terinstal!',
                      'Story Map telah berhasil diinstal di perangkat Anda.',
                      4000
                    );
                  }
                } catch (err) {
                  console.error('Error showing install notification:', err);
                }
              })();
            });
            
            // Check if already installed on page load
            if (isInstalled) {
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'none';
              }
            }
          } catch (error) {
            console.error('ServiceWorker registration failed: ', error);
          }
        });
      }

      // Listen for online/offline status
      function updateOnlineStatus() {
        const statusElement = document.getElementById('online-status');
        if (statusElement) {
          if (navigator.onLine) {
            statusElement.textContent = 'Online';
            statusElement.className = 'online';
          } else {
            statusElement.textContent = 'Offline - Working in offline mode';
            statusElement.className = 'offline';
          }
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      document.addEventListener('DOMContentLoaded', updateOnlineStatus);</script></body></html>