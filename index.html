<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="A story sharing platform where users can share their stories with locations on a map">
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Story Map">
    
    <!-- PWA Manifest - Must be in head and detected early -->
    <!-- Path will be corrected by inline script below -->
    <link rel="manifest" href="/manifest.webmanifest" id="manifest-link" crossorigin="use-credentials">
    <link rel="shortcut icon" href="/favicon.png" id="favicon-link">
    <link rel="apple-touch-icon" href="/images/logo.png" id="apple-touch-icon">

    <title>Story Map - Share Your Stories</title>
  <script defer="defer" src="/submitan-pertama-Intermediate/app.bundle.js"></script><link href="/submitan-pertama-Intermediate/app.css" rel="stylesheet"></head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <header>
      <div class="main-header container">
        <a class="brand-name" href="#/" aria-label="Story Map Home">
          <span class="brand-text">Story Map</span>
        </a>

        <nav id="navigation-drawer" class="navigation-drawer" aria-label="Main navigation">
          <ul id="nav-list" class="nav-list" role="menubar">
            <li role="none"><a href="#/" role="menuitem">Home</a></li>
            <li role="none"><a href="#/about" role="menuitem">About</a></li>
            <li role="none"><a href="#/add" role="menuitem">Add Story</a></li>
            <li role="none"><a href="#/favorite" role="menuitem">Favorite</a></li>
          </ul>
        </nav>

        <div class="header-actions">
          <button id="notification-toggle" class="header-btn notification-btn" aria-label="Toggle push notifications">
            <span class="btn-icon">üîî</span>
            <span class="btn-text notification-status">Notifications</span>
          </button>
          <button id="drawer-button" class="drawer-button" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="navigation-drawer">
            <span class="sr-only">Menu</span>
            ‚ò∞
          </button>
        </div>
      </div>
      <!-- Notification Container -->
      <div id="header-notification-container" class="header-notification-container" role="region" aria-live="polite" aria-atomic="true"></div>
    </header>

    <main id="main-content" class="main-content" tabindex="-1"></main>

    <footer class="footer">
      <div class="container">
        <p>&copy; 2025 Story Map. All rights reserved.</p>
        <div class="notification-controls" style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <button id="install-button" class="btn btn-secondary install-btn" style="display: inline-block;" aria-label="Install Story Map app">
            üì± Install App
          </button>
        </div>
      </div>
    </footer>

    <script>
      // Detect environment (development vs production)
      // Untuk local development (localhost, 127.0.0.1 dengan port), gunakan root path
      // Untuk Netlify, gunakan root path
      // Untuk production GitHub Pages, gunakan subdirectory
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const isNetlify = window.location.hostname.includes('netlify');
      const isGitHubPages = window.location.hostname.includes('github.io') && !isNetlify;
      // Untuk localhost dan Netlify, gunakan root path. Untuk GitHub Pages, gunakan subdirectory
      const BASE_PATH = isGitHubPages ? '/submitan-pertama-Intermediate' : '';
      
      // Helper function to create path
      const createPath = (path) => {
        const fullPath = BASE_PATH ? `${BASE_PATH}${path}` : path;
        return fullPath.replace(/\/+/g, '/'); // Replace multiple slashes with single slash
      };
      
      // Verify and correct manifest link
      const manifestLink = document.getElementById('manifest-link');
      if (manifestLink) {
        const expectedPath = isGitHubPages ? '/submitan-pertama-Intermediate/manifest.webmanifest' : '/manifest.webmanifest';
        const fullExpectedPath = window.location.origin + expectedPath;
        
        // Update manifest link if needed
        if (manifestLink.href !== fullExpectedPath && !manifestLink.href.includes(expectedPath)) {
          console.log('üîß Correcting manifest path from', manifestLink.href, 'to', expectedPath);
          manifestLink.href = expectedPath;
        }
        
        if (manifestLink.href.includes(expectedPath) || manifestLink.href === fullExpectedPath) {
          console.log('‚úÖ Manifest path is correct:', manifestLink.href);
        } else {
          console.warn('‚ö†Ô∏è Manifest path might be incorrect. Expected to contain:', expectedPath, 'but got:', manifestLink.href);
        }
      }
      
      // Update favicon path
      const faviconLink = document.getElementById('favicon-link');
      if (faviconLink) {
        const faviconPath = createPath('/favicon.png');
        if (faviconLink.href !== window.location.origin + faviconPath) {
          faviconLink.href = faviconPath;
        }
      }
      
      // Update apple touch icon path
      const appleIcon = document.getElementById('apple-touch-icon');
      if (appleIcon) {
        const iconPath = createPath('/images/logo.png');
        if (appleIcon.href !== window.location.origin + iconPath) {
          appleIcon.href = iconPath;
        }
      }
      
      // Update brand logo path
      // Logo image removed - no longer needed
      
      // Log manifest info for debugging and ensure it's detected by browser
      if (manifestLink) {
        console.log('üìã Manifest link:', manifestLink.href);
        console.log('üìã Manifest link element:', manifestLink);
        
        // Test if manifest is accessible and update icon paths for GitHub Pages
        fetch(manifestLink.href)
          .then(response => {
            if (response.ok) {
              console.log('‚úÖ Manifest is accessible (HTTP OK)');
              return response.json();
            } else {
              console.error('‚ùå Manifest not accessible:', response.status, response.statusText);
            }
          })
          .then(manifest => {
            if (manifest) {
              // Update icon paths for GitHub Pages
              if (isGitHubPages && manifest.icons) {
                manifest.icons.forEach(icon => {
                  if (icon.src && !icon.src.startsWith(BASE_PATH)) {
                    icon.src = createPath(icon.src);
                  }
                });
                
                // Update shortcuts icons too
                if (manifest.shortcuts) {
                  manifest.shortcuts.forEach(shortcut => {
                    if (shortcut.icons) {
                      shortcut.icons.forEach(icon => {
                        if (icon.src && !icon.src.startsWith(BASE_PATH)) {
                          icon.src = createPath(icon.src);
                        }
                      });
                    }
                  });
                }
                
                // Update start_url and scope for GitHub Pages
                if (isGitHubPages) {
                  if (manifest.start_url && !manifest.start_url.startsWith(BASE_PATH)) {
                    manifest.start_url = createPath(manifest.start_url);
                  }
                  if (manifest.scope && !manifest.scope.startsWith(BASE_PATH)) {
                    manifest.scope = createPath(manifest.scope);
                  }
                }
                
                // Create a new manifest blob and update the link
                const manifestBlob = new Blob([JSON.stringify(manifest, null, 2)], { type: 'application/json' });
                const manifestUrl = URL.createObjectURL(manifestBlob);
                manifestLink.href = manifestUrl;
                
                console.log('‚úÖ Manifest paths updated for GitHub Pages');
              }
              
              console.log('‚úÖ Manifest loaded successfully:');
              console.log('   Name:', manifest.name);
              console.log('   Short Name:', manifest.short_name);
              console.log('   Start URL:', manifest.start_url);
              console.log('   Scope:', manifest.scope);
              console.log('   Icons:', manifest.icons?.length || 0, 'icons');
              
              // Verify icons
              if (manifest.icons && manifest.icons.length > 0) {
                manifest.icons.forEach((icon, index) => {
                  console.log(`   Icon ${index + 1}:`, icon.src, icon.sizes);
                  // Test icon accessibility
                  fetch(icon.src.startsWith('blob:') ? icon.src : createPath(icon.src))
                    .then(iconResponse => {
                      if (iconResponse.ok) {
                        console.log(`   ‚úÖ Icon ${index + 1} (${icon.sizes}): Accessible`);
                      } else {
                        console.error(`   ‚ùå Icon ${index + 1} (${icon.sizes}): Not accessible (${iconResponse.status})`);
                      }
                    })
                    .catch(iconError => {
                      console.error(`   ‚ùå Icon ${index + 1} (${icon.sizes}): Error -`, iconError);
                    });
                });
              }
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading manifest:', error);
          });
        
        // Force browser to re-check manifest
        const newLink = document.createElement('link');
        newLink.rel = 'manifest';
        newLink.href = manifestLink.href;
        newLink.id = 'manifest-link-check';
        document.head.appendChild(newLink);
        setTimeout(() => {
          document.head.removeChild(newLink);
        }, 100);
      }
      
      // Check if browser detects PWA
      if ('serviceWorker' in navigator) {
        console.log('‚úÖ Service Worker API supported');
      } else {
        console.warn('‚ö†Ô∏è Service Worker API not supported');
      }
      
      if ('BeforeInstallPromptEvent' in window) {
        console.log('‚úÖ Install prompt API supported');
      } else {
        console.log('‚ÑπÔ∏è Install prompt will use beforeinstallprompt event');
      }
      
      // Log environment info
      console.log('Environment:', isLocalhost ? 'Development (Local)' : isNetlify ? 'Production (Netlify)' : isGitHubPages ? 'Production (GitHub Pages)' : 'Production');
      console.log('BASE_PATH:', BASE_PATH || '(root path)');
      console.log('Current URL:', window.location.href);

      // Helper function to wait for bundle to load
      async function waitForBundle(maxWait = 10000) {
        // Check immediately first
        if (window.NotificationHelper) {
          console.log('‚úÖ Bundle already loaded');
          return true;
        }
        
        console.log('‚è≥ Waiting for bundle to load...');
        const startTime = Date.now();
        let checkCount = 0;
        
        while (!window.NotificationHelper && (Date.now() - startTime) < maxWait) {
          checkCount++;
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Log every second
          if (checkCount % 10 === 0) {
            console.log(`‚è≥ Still waiting... (${Math.floor((Date.now() - startTime) / 1000)}s)`);
          }
        }
        
        const loaded = !!window.NotificationHelper;
        if (loaded) {
          console.log('‚úÖ Bundle loaded successfully');
        } else {
          console.error('‚ùå Bundle failed to load within timeout');
        }
        return loaded;
      }

      // Initialize everything after page loads
      // Use DOMContentLoaded instead of 'load' to start earlier
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('üìÑ DOM Content Loaded');
        
        // Wait a bit for bundle script to execute
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Check if bundle is loaded
        if (!window.NotificationHelper) {
          console.log('‚è≥ Bundle not yet loaded, waiting...');
          await waitForBundle();
        }
      });

      // Register service worker with correct scope for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            const swPath = createPath('/sw.js');
            const swScope = isGitHubPages ? '/submitan-pertama-Intermediate/' : '/';
            
            console.log('üîß Registering service worker...');
            console.log('   Path:', swPath);
            console.log('   Scope:', swScope);
            
            const registration = await navigator.serviceWorker.register(swPath, {
              scope: swScope
            });
            
            console.log('‚úÖ ServiceWorker registration successful');
            console.log('   Actual Scope:', registration.scope);
            console.log('   Active:', !!registration.active);
            console.log('   Installing:', !!registration.installing);
            console.log('   Waiting:', !!registration.waiting);
            
            // Wait for service worker to be ready
            if (registration.installing) {
              console.log('‚è≥ Service worker installing...');
              registration.installing.addEventListener('statechange', (e) => {
                console.log('   State changed to:', e.target.state);
              });
            }
            
            if (registration.waiting) {
              console.log('‚è≥ Service worker waiting...');
            }
            
            if (registration.active) {
              console.log('‚úÖ Service worker is active');
            }
            
            // Ensure bundle is loaded
            if (!window.NotificationHelper) {
              console.log('‚è≥ Waiting for bundle before initializing notifications...');
              await waitForBundle();
            }
            
            console.log('Bundle status:', {
              loaded: !!window.NotificationHelper,
              NotificationHelper: !!window.NotificationHelper,
              HeaderNotification: !!window.HeaderNotification,
              CONFIG: !!window.CONFIG,
              mapService: !!window.mapService
            });
            
            // Initialize notifications after service worker is ready
            try {
              await registration.ready;
              
              if (window.NotificationHelper) {
                // Check notification permission status
                const permissionStatus = Notification.permission;
                console.log('üì¢ Notification permission status:', permissionStatus);
                
                // Always check and request notification permission if needed
                console.log('üì¢ Current notification permission:', permissionStatus);
                
                if (permissionStatus === 'default') {
                  console.log('üì¢ Requesting notification permission automatically...');
                  // Show info message first
                  if (window.HeaderNotification) {
                    window.HeaderNotification.info(
                      'Izin Notifikasi',
                      'Kami akan meminta izin untuk menampilkan notifikasi',
                      3000
                    );
                  }
                  
                  // Request permission after a short delay
                  setTimeout(async () => {
                    try {
                      console.log('üì¢ Calling requestPermission()...');
                      const hasPermission = await window.NotificationHelper.requestPermission();
                      console.log('üì¢ Permission result:', hasPermission);
                      
                      if (hasPermission) {
                        console.log('‚úÖ Notification permission granted');
                        // Show success notification
                        if (window.HeaderNotification) {
                          window.HeaderNotification.success(
                            'Notifikasi Diaktifkan!',
                            'Anda akan menerima notifikasi dari Story Map',
                            4000
                          );
                        }
                        // Show test notification from browser
                        try {
                          await window.NotificationHelper.showLocalNotification(
                            'Notifikasi Diaktifkan',
                            {
                              body: 'Anda akan menerima notifikasi dari Story Map.',
                              icon: createPath('/images/logo.png'),
                              badge: createPath('/images/logo.png'),
                              tag: 'notification-enabled'
                            }
                          );
                          console.log('‚úÖ Test notification shown');
                        } catch (notifError) {
                          console.error('Error showing test notification:', notifError);
                        }
                      } else {
                        console.log('‚ùå Notification permission denied or dismissed');
                        if (window.HeaderNotification) {
                          window.HeaderNotification.warning(
                            'Izin Notifikasi Ditolak',
                            'Klik tombol Notifications di header untuk mengaktifkan notifikasi',
                            5000
                          );
                        }
                      }
                    } catch (error) {
                      console.error('‚ùå Error requesting notification permission:', error);
                      if (window.HeaderNotification) {
                        window.HeaderNotification.error(
                          'Error',
                          'Gagal meminta izin notifikasi: ' + error.message,
                          5000
                        );
                      }
                    }
                  }, 3000);
                } else if (permissionStatus === 'granted') {
                  console.log('‚úÖ Notification permission already granted');
                  // Show test notification to confirm it works
                  setTimeout(async () => {
                    try {
                      await window.NotificationHelper.showLocalNotification(
                        'Notifikasi Aktif',
                        {
                          body: 'Notifikasi Story Map sudah aktif!',
                          icon: createPath('/images/logo.png'),
                          tag: 'notification-check'
                        }
                      );
                    } catch (error) {
                      console.error('Error showing check notification:', error);
                    }
                  }, 2000);
                } else {
                  console.log('‚ùå Notification permission was denied');
                  if (window.HeaderNotification) {
                    window.HeaderNotification.warning(
                      'Izin Notifikasi Ditolak',
                      'Silakan aktifkan notifikasi di pengaturan browser',
                      5000
                    );
                  }
                }
                
                await window.NotificationHelper.initialize();
                console.log('‚úÖ Notifications initialized');
              } else {
                console.warn('‚ö†Ô∏è NotificationHelper not available after waiting');
              }
            } catch (error) {
              console.error('‚ùå Error initializing notifications:', error);
            }
            
            // Initialize notification toggle
            const notificationToggle = document.getElementById('notification-toggle');
            if (notificationToggle) {
              let isProcessing = false; // Prevent double-click
              
              notificationToggle.addEventListener('click', async (e) => {
                // Prevent double-click
                if (isProcessing) {
                  console.log('Notification toggle is already processing, ignoring click');
                  return;
                }

                // Check if it's a long press or right click for test notification
                if (e.shiftKey || e.ctrlKey) {
                  e.preventDefault();
                  try {
                    if (!window.NotificationHelper) {
                      alert('NotificationHelper belum dimuat. Silakan refresh halaman.');
                      return;
                    }
                    const result = await window.NotificationHelper.testNotification();
                    if (!result) {
                      alert('Notifikasi tidak dapat ditampilkan. Pastikan izin notifikasi sudah diberikan.');
                    }
                  } catch (error) {
                    console.error('Error testing notification:', error);
                    alert('Gagal menampilkan notifikasi test: ' + error.message);
                  }
                  return;
                }

                isProcessing = true;
                const originalText = notificationToggle.querySelector('.notification-status')?.textContent || '';
                
                try {
                  // Disable button during processing
                  notificationToggle.disabled = true;
                  
                  if (!window.NotificationHelper || !window.CONFIG) {
                    throw new Error('Modul belum dimuat. Silakan refresh halaman.');
                  }
                  
                  const NotificationHelper = window.NotificationHelper;
                  const CONFIG = window.CONFIG;
                  
                  // Check if push is supported
                  if (!(await NotificationHelper.isPushSupported())) {
                    throw new Error('Push notifications are not supported in this browser.');
                  }

                  // Get current subscription status
                  const subscription = await NotificationHelper.getSubscription();
                  
                  if (subscription) {
                    // Unsubscribe
                    const statusSpan = notificationToggle.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = 'Disabling...';
                    }
                    
                    const token = localStorage.getItem('token');
                    await NotificationHelper.unsubscribeUser(token);
                    
                    // Verify unsubscribe was successful
                    const verifySubscription = await NotificationHelper.getSubscription();
                    if (!verifySubscription) {
                      // Update UI only after successful unsubscribe
                      if (statusSpan) {
                        statusSpan.textContent = 'Enable Notifications';
                      }
                      notificationToggle.classList.remove('active');
                      
                      if (window.HeaderNotification) {
                        window.HeaderNotification.success(
                          'Notifikasi Dinonaktifkan',
                          'Notifikasi push telah dinonaktifkan.',
                          3000
                        );
                      }
                      console.log('‚úÖ Unsubscribed from push notifications');
                    } else {
                      throw new Error('Gagal menonaktifkan notifikasi. Silakan coba lagi.');
                    }
                  } else {
                    // Subscribe
                    const statusSpan = notificationToggle.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = 'Enabling...';
                    }

                    // Request notification permission first
                    const hasPermission = await NotificationHelper.requestPermission();
                    if (!hasPermission) {
                      throw new Error('Izin notifikasi ditolak. Silakan aktifkan di pengaturan browser.');
                    }

                    const newSubscription = await NotificationHelper.subscribeUser(CONFIG.VAPID_PUBLIC_KEY);
                    
                    if (!newSubscription) {
                      throw new Error('Gagal berlangganan push notification. Silakan coba lagi.');
                    }
                    
                    // Verify subscription was successful
                    const verifySubscription = await NotificationHelper.getSubscription();
                    if (!verifySubscription) {
                      throw new Error('Subscription gagal dibuat. Silakan coba lagi.');
                    }
                    
                    // Send subscription to server
                    const token = localStorage.getItem('token');
                    if (token) {
                      const success = await NotificationHelper.sendSubscriptionToServer(newSubscription, token);
                      if (success) {
                        // Update UI after successful server sync
                        if (statusSpan) {
                          statusSpan.textContent = 'Disable Notifications';
                        }
                        notificationToggle.classList.add('active');
                        
                        if (window.HeaderNotification) {
                          window.HeaderNotification.success(
                            'Notifikasi Diaktifkan',
                            'Notifikasi push telah diaktifkan dan tersinkron dengan server.',
                            3000
                          );
                        }
                        console.log('‚úÖ Subscribed to push notifications');
                      } else {
                        // Still update UI even if server sync fails
                        if (statusSpan) {
                          statusSpan.textContent = 'Disable Notifications';
                        }
                        notificationToggle.classList.add('active');
                        
                        // Show user-friendly notification
                        if (window.HeaderNotification) {
                          window.HeaderNotification.warning(
                            'Notifikasi Diaktifkan (Lokal)',
                            'Notifikasi berhasil diaktifkan di browser, tetapi gagal terhubung ke server. Aplikasi akan mencoba lagi secara otomatis saat online.',
                            7000
                          );
                        }
                        console.log('‚ö†Ô∏è Subscribed locally, server sync failed');
                      }
                    } else {
                      // Store subscription locally if not logged in
                      if (statusSpan) {
                        statusSpan.textContent = 'Disable Notifications';
                      }
                      notificationToggle.classList.add('active');
                      
                      if (window.HeaderNotification) {
                        window.HeaderNotification.info(
                          'Notifikasi Diaktifkan',
                          'Notifikasi telah diaktifkan. Akan tersinkron saat Anda login.',
                          5000
                        );
                      }
                      console.log('‚úÖ Subscribed to push notifications (will sync when logged in)');
                    }
                  }
                } catch (error) {
                  console.error('Error toggling notifications:', error);
                  
                  // Restore original text on error
                  const statusSpan = notificationToggle.querySelector('.notification-status');
                  if (statusSpan) {
                    statusSpan.textContent = originalText;
                  }
                  
                  // Show error notification
                  if (window.HeaderNotification) {
                    window.HeaderNotification.error(
                      'Gagal Mengubah Pengaturan',
                      error.message || 'Terjadi kesalahan saat mengubah pengaturan notifikasi.',
                      5000
                    );
                  } else {
                    alert('Gagal mengubah pengaturan notifikasi: ' + error.message);
                  }
                } finally {
                  // Re-enable button
                  isProcessing = false;
                  notificationToggle.disabled = false;
                }
              });

              // Update button text based on current subscription
              (async () => {
                try {
                  // Wait for bundle to load
                  const bundleLoaded = await waitForBundle();
                  
                  if (!bundleLoaded || !window.NotificationHelper) {
                    console.warn('NotificationHelper not available');
                    const toggleBtn = document.getElementById('notification-toggle');
                    if (toggleBtn) {
                      toggleBtn.style.display = 'none';
                    }
                    return;
                  }

                  const NotificationHelper = window.NotificationHelper;
                  
                  // Check if push is supported
                  const isPushSupported = await NotificationHelper.isPushSupported();
                  console.log('Push notifications supported:', isPushSupported);
                  
                  const toggleBtn = document.getElementById('notification-toggle');
                  if (!isPushSupported) {
                    if (toggleBtn) {
                      console.log('Hiding notification button - push not supported');
                      toggleBtn.style.display = 'none';
                    }
                    return;
                  }

                  // Ensure button is visible and enabled
                  if (toggleBtn) {
                    toggleBtn.style.display = '';
                    toggleBtn.disabled = false;
                    console.log('‚úÖ Notification button is visible and enabled');
                  }

                  const subscription = await NotificationHelper.getSubscription();
                  console.log('Current subscription:', !!subscription);
                  
                  if (toggleBtn) {
                    const statusSpan = toggleBtn.querySelector('.notification-status');
                    if (statusSpan) {
                      statusSpan.textContent = subscription ? 'Disable Notifications' : 'Enable Notifications';
                    }
                    // Add active class if subscribed
                    if (subscription) {
                      toggleBtn.classList.add('active');
                    } else {
                      toggleBtn.classList.remove('active');
                    }
                    console.log('‚úÖ Notification button updated');
                  }
                } catch (error) {
                  console.error('‚ùå Error checking notification status:', error);
                  // Keep button visible even on error
                  const toggleBtn = document.getElementById('notification-toggle');
                  if (toggleBtn) {
                    toggleBtn.style.display = '';
                    toggleBtn.disabled = false;
                    console.log('‚úÖ Notification button kept visible despite error');
                  }
                }
              })();
            }

            // Handle PWA install prompt
            let deferredPrompt = null;
            let installButtonClickHandler = null;
            
            // Check if app is already installed
            const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone || 
                               document.referrer.includes('android-app://');
            
            // Show install button in footer if not installed
            const showInstallButton = () => {
              const installButton = document.getElementById('install-button');
              if (installButton && !isInstalled) {
                installButton.style.display = 'inline-block';
                console.log('‚úÖ Install button shown');
              }
            };
            
            // Log install prompt availability and PWA criteria
            console.log('üîç Checking for install prompt support...');
            console.log('   Service Worker support:', 'serviceWorker' in navigator);
            const manifestLinkEl = document.querySelector('link[rel="manifest"]');
            console.log('   Manifest link:', manifestLinkEl?.href);
            console.log('   Is installed:', isInstalled);
            console.log('   Display mode:', window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser');
            
            // Check PWA installability criteria
            if (manifestLinkEl) {
              fetch(manifestLinkEl.href)
                .then(response => {
                  if (response.ok) {
                    return response.json();
                  }
                  throw new Error(`HTTP ${response.status}`);
                })
                .then(manifest => {
                  console.log('üìã PWA Criteria Check:');
                  console.log('   ‚úÖ Manifest: Valid');
                  console.log('   ‚úÖ Icons:', manifest.icons?.length || 0, 'icons');
                  console.log('   ‚úÖ Start URL:', manifest.start_url);
                  console.log('   ‚úÖ Scope:', manifest.scope);
                  console.log('   ‚úÖ Display:', manifest.display);
                  
                  // Check if icons are accessible
                  if (manifest.icons && manifest.icons.length > 0) {
                    manifest.icons.forEach((icon, index) => {
                      fetch(icon.src)
                        .then(response => {
                          if (response.ok) {
                            console.log(`   ‚úÖ Icon ${index + 1} (${icon.sizes}): Accessible`);
                          } else {
                            console.error(`   ‚ùå Icon ${index + 1} (${icon.sizes}): Not accessible (${response.status})`);
                          }
                        })
                        .catch(error => {
                          console.error(`   ‚ùå Icon ${index + 1} (${icon.sizes}): Error -`, error.message);
                        });
                    });
                  }
                })
                .catch(error => {
                  console.error('‚ùå Error checking manifest:', error);
                });
            }
            
            window.addEventListener('beforeinstallprompt', (e) => {
              console.log('üéâ beforeinstallprompt event fired!');
              e.preventDefault();
              deferredPrompt = e;
              
              // Show install button
              showInstallButton();
              
              const installButton = document.getElementById('install-button');
              if (installButton) {
                // Remove existing listener if any
                if (installButtonClickHandler) {
                  installButton.removeEventListener('click', installButtonClickHandler);
                }
                
                // Add new click handler
                installButtonClickHandler = async () => {
                  if (deferredPrompt) {
                    try {
                      console.log('üì± Showing install prompt...');
                      deferredPrompt.prompt();
                      const { outcome } = await deferredPrompt.userChoice;
                      console.log(`User response to install prompt: ${outcome}`);
                      
                      if (outcome === 'accepted') {
                        console.log('‚úÖ User accepted installation');
                        // Show success message
                        try {
                          if (window.HeaderNotification) {
                            window.HeaderNotification.success(
                            'Aplikasi Berhasil Diinstal',
                            'Terima kasih! Aplikasi Story Map sedang diinstal.',
                            3000
                          );
                          }
                        } catch (err) {
                          alert('Terima kasih! Aplikasi Story Map sedang diinstal.');
                        }
                      } else {
                        console.log('‚ùå User dismissed installation');
                      }
                      
                      deferredPrompt = null;
                      installButton.style.display = 'none';
                    } catch (error) {
                      console.error('‚ùå Error showing install prompt:', error);
                      alert('Gagal menampilkan prompt instalasi: ' + error.message);
                    }
                  } else {
                    console.warn('‚ö†Ô∏è deferredPrompt is null');
                  }
                };
                
                installButton.addEventListener('click', installButtonClickHandler);
                console.log('‚úÖ Install button click handler attached');
              } else {
                console.error('‚ùå Install button not found in DOM');
              }
            });
            
            // Always show install button after page loads (if not installed)
            setTimeout(async () => {
              if (!isInstalled) {
                console.log('üîç Checking PWA requirements...');
                console.log('Service Worker:', 'serviceWorker' in navigator);
                const manifestHref = document.querySelector('link[rel="manifest"]')?.href;
                console.log('Manifest:', manifestHref);
                
                // Check if manifest is accessible
                if (manifestHref) {
                  try {
                    const manifestResponse = await fetch(manifestHref);
                    if (manifestResponse.ok) {
                      const manifest = await manifestResponse.json();
                      console.log('‚úÖ Manifest loaded:', manifest);
                    } else {
                      console.error('‚ùå Manifest not accessible:', manifestResponse.status);
                    }
                  } catch (error) {
                    console.error('‚ùå Error loading manifest:', error);
                  }
                }
                
                // Check service worker registration
                try {
                  const registration = await navigator.serviceWorker.getRegistration();
                  console.log('Service Worker registered:', !!registration);
                  if (registration) {
                    console.log('Service Worker scope:', registration.scope);
                    console.log('Service Worker active:', !!registration.active);
                  }
                } catch (error) {
                  console.error('Error checking service worker:', error);
                }
                
                // Always show install button (even if beforeinstallprompt didn't fire)
                const installButton = document.getElementById('install-button');
                if (installButton) {
                  installButton.style.display = 'inline-block';
                  installButton.textContent = 'üì± Install App';
                  
                  // Set click handler based on whether we have deferredPrompt
                  if (deferredPrompt && installButtonClickHandler) {
                    // Use the beforeinstallprompt handler if available
                    installButton.onclick = installButtonClickHandler;
                    console.log('‚úÖ Install button with prompt handler');
                  } else {
                    // Use manual install instructions
                  installButton.onclick = () => {
                      if (deferredPrompt) {
                        // Try to use prompt if available
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                          if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted install');
                            if (window.HeaderNotification) {
                              window.HeaderNotification.success(
                                'Aplikasi Berhasil Diinstal',
                                'Terima kasih! Aplikasi Story Map sedang diinstal.',
                                3000
                              );
                            }
                          }
                          deferredPrompt = null;
                        });
                      } else {
                        // Show manual instructions
                    const instructions = 
                      'Cara Install Aplikasi:\n\n' +
                      'Chrome/Edge Desktop:\n' +
                      '‚Ä¢ Klik menu (‚ãÆ) di kanan atas\n' +
                      '‚Ä¢ Pilih "Install Story Map"\n\n' +
                      'Chrome Android:\n' +
                      '‚Ä¢ Klik menu (‚ãÆ) > "Install app"\n\n' +
                      'Safari iOS:\n' +
                      '‚Ä¢ Klik tombol Share (‚ñ°‚Üë)\n' +
                      '‚Ä¢ Pilih "Add to Home Screen"\n\n' +
                      'Firefox:\n' +
                      '‚Ä¢ Klik menu (‚ò∞) > "Install"';
                    alert(instructions);
                      }
                  };
                    console.log('üì± Install button shown with manual instructions');
                  }
                }
              } else {
                console.log('‚úÖ App already installed');
              }
            }, 2000);

            // Listen for app installed
            window.addEventListener('appinstalled', () => {
              console.log('PWA was installed');
              deferredPrompt = null;
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'none';
              }
              
              // Show notification
              (async () => {
                try {
                  if (window.HeaderNotification) {
                    window.HeaderNotification.success(
                    'Aplikasi Terinstal!',
                    'Story Map telah berhasil diinstal di perangkat Anda.',
                    4000
                  );
                  }
                } catch (err) {
                  console.error('Error showing install notification:', err);
                }
              })();
            });
            
            // Check if already installed on page load
            if (isInstalled) {
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'none';
                console.log('‚úÖ App already installed - hiding install button');
              }
            } else {
              // Ensure install button is visible if not installed
              const installButton = document.getElementById('install-button');
              if (installButton) {
                installButton.style.display = 'inline-block';
                console.log('‚úÖ Install button visible (app not installed)');
              }
            }
          } catch (error) {
            console.error('ServiceWorker registration failed: ', error);
          }
        });
      }

      // Listen for online/offline status
      function updateOnlineStatus() {
        const statusElement = document.getElementById('online-status');
        if (statusElement) {
          if (navigator.onLine) {
            statusElement.textContent = 'Online';
            statusElement.className = 'online';
          } else {
            statusElement.textContent = 'Offline - Working in offline mode';
            statusElement.className = 'offline';
          }
        }
      }

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      document.addEventListener('DOMContentLoaded', updateOnlineStatus);
    </script>
  </body>
</html>
