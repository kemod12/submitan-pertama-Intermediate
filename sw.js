const CACHE_NAME="story-map-v6",OFFLINE_URL="/offline.html",CORE_ASSETS=["/","/index.html","/app.bundle.js","/app.css","/images/logo.png","/favicon.ico","/manifest.webmanifest"];self.addEventListener("install",(e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[Service Worker] Caching core assets"),e.addAll(CORE_ASSETS).catch((e=>{console.error("Failed to cache some assets:",e)}))))).then((()=>self.skipWaiting())))})),self.addEventListener("activate",(e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>e!==CACHE_NAME?(console.log("[Service Worker] Removing old cache:",e),caches.delete(e)):null)).filter(Boolean)))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(e=>{e.request.url.startsWith(self.location.origin)&&e.respondWith(caches.match(e.request).then((t=>{if(t)return t;const n=e.request.clone();return fetch(n).then((t=>{if(!t||200!==t.status||"basic"!==t.type)return t;const n=t.clone();return caches.open(CACHE_NAME).then((t=>{t.put(e.request,n)})),t})).catch((()=>"navigate"===e.request.mode?caches.match(OFFLINE_URL):new Response("You are offline and no cache is available.",{status:408,headers:{"Content-Type":"text/plain"}})))})))})),self.addEventListener("fetch",(e=>{const{request:t}=e,n=new URL(t.url),o=n.pathname.split("/").pop();if(["acs.bundle.js","aom.css"].some((e=>o.includes(e))))return console.warn("[SW] Ignoring request for non-existent file:",t.url),void e.respondWith(new Response("",{status:404,statusText:"Not Found",headers:{"Content-Type":"text/plain"}}));t.url.includes("/v1/")||t.url.includes("story-api.dicoding.dev")||n.origin===self.location.origin&&("navigate"!==t.mode?e.respondWith(caches.match(t).then((e=>e&&!t.url.includes("/v1/")?e:t.url.includes("/v1/")?fetch(t).catch((()=>e||new Response(JSON.stringify({error:"Offline"}),{status:503,headers:{"Content-Type":"application/json"}}))):fetch(t).then((e=>{if(!e||200!==e.status||"basic"!==e.type)return e&&404===e.status?(console.warn("[SW] 404 error for:",t.url),e):e;const n=e.clone();return"GET"===t.method&&caches.open(CACHE_NAME).then((e=>{e.put(t,n)})),e})).catch((n=>(console.warn("[SW] Network error for:",t.url,n),e||("image"===t.destination?new Response("",{status:404}):new Response("",{status:404,statusText:"Not Found",headers:{"Content-Type":"text/plain"}})))))))):e.respondWith(fetch(t).then((e=>{const n=e.clone();return caches.open(CACHE_NAME).then((e=>{e.put(t,n)})),e})).catch((()=>(console.log("[SW] Network failed for navigation, serving from cache"),caches.match(t).then((e=>{if(e)return console.log("[SW] Serving cached page:",t.url),e;const n=createPath("/offline.html");return console.log("[SW] No cached page found, serving offline.html"),caches.match(n)||caches.match("/offline.html")||caches.match(createPath("/index.html"))})))))))})),self.addEventListener("push",(function(e){console.log("[Service Worker] Push received");const t={title:"Story Map",options:{body:"Anda memiliki notifikasi baru",icon:"/images/logo.png",badge:"/images/logo.png",data:{url:"/",timestamp:Date.now()}}},n=e=>{const t=e.title||"Story berhasil dibuat",n={body:e.options?.body||"Anda memiliki notifikasi baru",icon:e.options?.icon||"/images/logo.png",badge:"/images/logo.png",data:{url:e.options?.url||"/",timestamp:Date.now()}};return self.registration.showNotification(t,n).then((()=>console.log("Notification shown successfully"))).catch((e=>console.error("Error showing notification:",e)))};try{const o=(e=>{try{if(e.data)try{return e.data.json()}catch(t){console.log("Push data is not JSON, trying as text");const n=e.data.text();try{return JSON.parse(n)}catch(e){return console.log("Push data is plain text"),{title:"Notifikasi",options:{body:n}}}}return t}catch(e){return console.error("Error parsing push data:",e),t}})(e);e.waitUntil(n(o))}catch(o){console.error("Error in push event handler:",o),e.waitUntil(n(t))}})),self.addEventListener("notificationclick",(e=>{console.log("Notification click received",e),e.notification.close();const t=(e.notification.data||{}).url||"/";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const n of e)if(n.url.includes(t)&&"focus"in n)return n.focus();if(clients.openWindow)return clients.openWindow(t)})).catch((e=>{console.error("Error handling notification click:",e)})))})),self.addEventListener("sync",(e=>{"sync-stories"===e.tag&&e.waitUntil(self.clients.matchAll().then((e=>Promise.all(e.map((e=>e.postMessage({type:"SYNC_STORIES"})))))))})),self.addEventListener("message",(e=>{e.data&&"TRIGGER_SYNC"===e.data.type&&e.waitUntil(self.clients.matchAll().then((e=>{e.forEach((e=>{e.postMessage({type:"SYNC_STORIES"})}))})))}));